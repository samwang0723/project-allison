let activeDiv=null,currentMsg="",refreshBottom=!0,mode="desktop";function startLoading(){document.getElementById("button-submit").style.display="none",document.getElementById("loading").style.display="block"}function stopLoading(){document.getElementById("button-submit").style.display="block",document.getElementById("loading").style.display="none"}function linkify(e){var t,n,s,i;return n=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,t=e.replace(n,"[$1]($1)"),s=/(^|[^\/])(www\.[\S]+(\b|$))/gim,t=t.replace(s,"[$1]($2)"),i=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(i,"[$1](mailto:$1)")}function boldify(e){var t,n;return n=/(Subject:|Summary:|Description:|Sources:|Attachments:|Similarity:|Prompt:)/gim,t=e.replace(n,"___$1___")}function addMessageRow(e){let t=document.createElement("div");t.classList.add("message-row");let n=document.createElement("span");n.classList.add("message-sender"),n.innerHTML='<img width="50px" height="50px" src="static/'+e+'.svg">',t.appendChild(n);let s=document.createElement("span");s.classList.add("message-body"),activeDiv=s,t.appendChild(s);let i=document.createElement("span");i.classList.add("message-tail"),t.appendChild(i);document.getElementById("messages").appendChild(t)}function extractImageUrls(e){let t=e.match(/href=["'][^"']*?\.(png|jpe?g|gif|pdf|asp)(?:\?[^"']*)?["']/g);if(!t)return[];let n=t.map(e=>e.slice(6,-1));return n}function formatMessage(e,t){console.log(e);let n=e.split("```"),s="";for(let i=0;i<n.length;i++)if(msg=n[i],i%2==1){let a=msg.split("\n"),l=a.shift().trim(),o=a.join("\n");(""===l||"html"===l)&&(o=o.replace(/</g,"&lt;").replace(/>/g,"&gt;")),code_class="language-",""!=l&&(code_class="language-"+l),s+='<pre class="prettyprint line-numbers language-markup"><code class="'+code_class+'">'+o+"</code></pre>"}else{boldified=boldify(linkified=linkify(msg));let r=window.markdownit(),c=r.render(boldified);s+=c}if(images=[],t&&(images=extractImageUrls(s)).length>0){imageBlock="<div class='thumbnails'>";for(let d=0;d<images.length;d++){let g=images[d];g.includes(".pdf")?imageBlock+="<div class='thumbnail' data-src='"+g+"' style='background-image:url(static/pdf.png)'></div>":imageBlock+="<div class='thumbnail' data-src='"+g+"' style='background-image:url("+g+")'></div>"}imageBlock+="</div>",s+=imageBlock}if(activeDiv.innerHTML=removeAttachments(s),Prism.highlightAllUnder(activeDiv),refreshBottom){let m=document.getElementById("messages");m.scrollTop=m.scrollHeight}if(t&&images.length>0)for(var u=document.getElementsByClassName("thumbnail"),f=function(){let e=this.getAttribute("data-src");window.open(e,"_blank")},p=0;p<u.length;p++)u[p].addEventListener("click",f,!1)}function removeAttachments(e){let t=e.indexOf("<em><strong>Attachments:</strong></em>"),n=e.indexOf("<div class='thumbnails'>",t);return -1!==t&&-1!==n?e.slice(0,t)+e.slice(n):e}$(document).ready(function(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(mode="mobile");var e=io.connect(window.location.origin,{transports:["websocket"]});e.on("connect",function(){console.log("Connected to the server."),addMessageRow("allison"),formatMessage("Server connected. How may I assist you today?",!0),activeDiv=null,currentMsg="",e.emit("mode",mode)}),e.on("disconnect",()=>{console.log("Connection closed"),addMessageRow("allison"),formatMessage("Connection closed",!0),stopLoading()}),e.on("connect_error",e=>{console.log("Connection error:",e),addMessageRow("allison"),formatMessage("Connection error: "+e,!0),stopLoading()}),e.on("connect_timeout",()=>{console.log("Connection timeout"),addMessageRow("allison"),formatMessage("Connection timeout",!0),stopLoading()}),e.on("message",function(e){if("[[stop]]"===e){formatMessage(currentMsg,!0),activeDiv=null,currentMsg="",stopLoading();return}currentMsg+=e,activeDiv||addMessageRow("allison"),formatMessage(currentMsg,!1)}),$("#chat_form").on("submit",function(t){startLoading(),t.preventDefault();var n=$("#message-textfield").val();""!==n&&(addMessageRow("user"),formatMessage(n,!0),e.emit("message",n),$("#message-textfield").val(""),$("#message-textfield").height(40),activeDiv=null,currentMsg="")});let t=document.getElementById("message-textfield");t.addEventListener("keydown",function(e){if("Enter"===e.key&&e.shiftKey){e.preventDefault();let t=this.value;this.value=t+"\n"}}),t.oninput=function(){t.style.height="52px",t.style.height=Math.min(t.scrollHeight,400)+"px"};let n=document.getElementById("messages");n.addEventListener("scroll",function(){refreshBottom=n.scrollTop+n.clientHeight>=n.scrollHeight-60});let s=document.getElementById("file-input"),i=document.getElementById("upload-button");i.addEventListener("click",function(){s.click()}),s.addEventListener("change",()=>{let t=s.files[0],n=new FileReader;n.onload=function(){let s=n.result,i=t.name;e.emit("upload_image",{image:s,filename:i})},n.readAsDataURL(t)}),$("#btn-prompt").on("click",function(){e.emit("message","command:prompt"),startLoading()}),$("#btn-similarity").on("click",function(){e.emit("message","command:similarity"),startLoading()}),$("#btn-reset").on("click",function(){e.emit("message","command:reset_session"),startLoading()})});
